name: Processar EPG com Offset ConfigurÃ¡vel

on:
  schedule:
    - cron: '0 4 * * *'  # 04:00 UTC = 05:00 Portugal
  workflow_dispatch:
    inputs:
      offset_seconds:
        description: 'Offset em segundos (pode ser negativo, ex: -30, +45)'
        required: false
        default: ''
        type: string
      update_default:
        description: 'Atualizar offset padrÃ£o permanentemente?'
        required: false
        default: false
        type: boolean

jobs:
  process-epg:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Definir offset padrÃ£o (se solicitado)
        if: ${{ github.event.inputs.update_default == 'true' && github.event.inputs.offset_seconds != '' }}
        run: |
          echo "ðŸ”§ Definindo novo offset padrÃ£o: ${{ github.event.inputs.offset_seconds }}s"
          python processar.py --set-offset ${{ github.event.inputs.offset_seconds }}

      - name: Processar EPG
        run: |
          echo "ðŸš€ Iniciando processamento EPG..."
          
          if [ "${{ github.event.inputs.offset_seconds }}" != "" ]; then
            echo "ðŸ“± Usando offset da App/Manual: ${{ github.event.inputs.offset_seconds }}s"
            python processar.py --offset ${{ github.event.inputs.offset_seconds }}
          else
            echo "âš™ï¸ Usando offset da configuraÃ§Ã£o padrÃ£o"
            python processar.py --config
          fi
          
          echo "âœ… Processamento concluÃ­do"

      - name: Verificar ficheiros gerados
        run: |
          if [ ! -f "compilacao.xml.gz" ]; then
            echo "âŒ Erro: compilacao.xml.gz nÃ£o foi criado"
            exit 1
          fi
          
          echo "ðŸ“Š InformaÃ§Ãµes dos ficheiros gerados:"
          ls -lh compilacao.xml*
          
          # Mostrar configuraÃ§Ã£o atual
          if [ -f "config.json" ]; then
            echo "âš™ï¸ ConfiguraÃ§Ã£o atual:"
            cat config.json | python -m json.tool
          fi
          
          echo "âœ… Ficheiros criados com sucesso"

      - name: Preparar commit message
        id: commit_msg
        run: |
          # Determinar offset usado
          if [ "${{ github.event.inputs.offset_seconds }}" != "" ]; then
            OFFSET="${{ github.event.inputs.offset_seconds }}"
            SOURCE="App/Manual"
          else
            # Extrair offset do config.json se existir
            if [ -f "config.json" ]; then
              OFFSET=$(python -c "import json; print(json.load(open('config.json'))['offset_seconds'])")
              SOURCE="Config"
            else
              OFFSET="30"
              SOURCE="PadrÃ£o"
            fi
          fi
          
          # Criar mensagem de commit
          if [ "$OFFSET" -gt 0 ]; then
            OFFSET_STR="+${OFFSET}s"
          else
            OFFSET_STR="${OFFSET}s"
          fi
          
          COMMIT_MSG="EPG atualizado (${OFFSET_STR}) - $(date '+%Y-%m-%d %H:%M UTC') [${SOURCE}]"
          echo "commit_message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "offset_used=${OFFSET}" >> $GITHUB_OUTPUT

      - name: Commit e Push (apenas se houver mudanÃ§as)
        run: |
          git config --local user.name 'xmltune-bot[bot]'
          git config --local user.email 'xmltune-bot@users.noreply.github.com'

          # Adicionar ficheiros gerados
          git add compilacao.xml compilacao.xml.gz
          
          # Adicionar config.json se foi modificado
          if [ -f "config.json" ]; then
            git add config.json
          fi
          
          # Verificar se hÃ¡ alteraÃ§Ãµes
          if git diff --cached --quiet; then
            echo "ðŸ“ Sem alteraÃ§Ãµes nos ficheiros - fonte nÃ£o foi atualizada"
            exit 0
          fi

          echo "ðŸ“ AlteraÃ§Ãµes detetadas - a fazer commit..."
          echo "ðŸ’¬ Mensagem: ${{ steps.commit_msg.outputs.commit_message }}"
          git commit -m "${{ steps.commit_msg.outputs.commit_message }}"
          
          # Push com retry
          for attempt in {1..3}; do
            if git push; then
              echo "âœ… Push bem-sucedido na tentativa $attempt"
              echo "ðŸŽ¯ Offset aplicado: ${{ steps.commit_msg.outputs.offset_used }}s"
              break
            else
              echo "âš ï¸ Push falhou na tentativa $attempt"
              if [ $attempt -lt 3 ]; then
                echo "ðŸ”„ A tentar novamente em 10 segundos..."
                sleep 10
                git pull --rebase origin main
              else
                echo "âŒ Falha definitiva no push apÃ³s 3 tentativas"
                exit 1
              fi
            fi
          done

      - name: Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸ“‹ Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "**Offset aplicado:** ${{ steps.commit_msg.outputs.offset_used }}s" >> $GITHUB_STEP_SUMMARY
          echo "**Data/Hora:** $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "compilacao.xml.gz" ]; then
            SIZE=$(ls -lh compilacao.xml.gz | awk '{print $5}')
            echo "**Ficheiro gerado:** compilacao.xml.gz (${SIZE})" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status:** Sucesso" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Falha" >> $GITHUB_STEP_SUMMARY
          fi
