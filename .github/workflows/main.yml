name: Processar EPG Automático

on:
  schedule:
    - cron: '0 4 * * *'  # 04:00 UTC diário (05:00 Portugal)
  workflow_dispatch:
    inputs:
      offset_seconds:
        description: 'Offset em segundos (+30, -30, etc.)'
        required: false
        default: ''
        type: string
      update_default:
        description: 'Atualizar offset padrão permanentemente?'
        required: false
        default: false
        type: boolean

jobs:
  process-epg:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repositório
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ⚙️ Configurar Git
        run: |
          git config --local user.name 'xmltune-bot[bot]'
          git config --local user.email 'xmltune-bot@users.noreply.github.com'

      - name: 🔄 Sincronizar com remote
        run: |
          echo "🔄 Sincronizando com repositório remoto..."
          git pull origin main --no-edit || echo "⚠️ Pull falhou, continuando..."

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📦 Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🎯 Processar EPG
        run: |
          echo "🚀 Iniciando processamento EPG..."
          
          if [ "${{ github.event.inputs.offset_seconds }}" != "" ]; then
            echo "📱 Usando offset da App/Manual: ${{ github.event.inputs.offset_seconds }}s"
            python processar.py --offset ${{ github.event.inputs.offset_seconds }}
          else
            echo "⚙️ Usando offset da configuração padrão"
            python processar.py --config
          fi
          
          echo "✅ Processamento concluído"

      - name: 📝 Atualizar offset padrão
        if: ${{ github.event.inputs.update_default == 'true' && github.event.inputs.offset_seconds != '' }}
        run: |
          echo "🔧 Definindo novo offset padrão: ${{ github.event.inputs.offset_seconds }}s"
          python processar.py --set-offset ${{ github.event.inputs.offset_seconds }}

      - name: 🔍 Verificar ficheiros gerados
        run: |
          if [ ! -f "compilacao.xml.gz" ]; then
            echo "❌ Erro: compilacao.xml.gz não foi criado"
            exit 1
          fi
          
          if [ ! -f "compilacao.xml" ]; then
            echo "❌ Erro: compilacao.xml não foi criado"
            exit 1
          fi
          
          echo "📊 Informações dos ficheiros gerados:"
          ls -lh compilacao.xml*
          
          # Mostrar configuração atual
          if [ -f "config.json" ]; then
            echo "⚙️ Configuração atual:"
            cat config.json | python -m json.tool
          fi
          
          echo "✅ Ficheiros criados com sucesso"

      - name: 📋 Preparar informações do commit
        id: commit_info
        run: |
          # Determinar offset usado
          if [ "${{ github.event.inputs.offset_seconds }}" != "" ]; then
            OFFSET="${{ github.event.inputs.offset_seconds }}"
            SOURCE="App/Manual"
          else
            # Extrair offset do config.json se existir
            if [ -f "config.json" ]; then
              OFFSET=$(python -c "import json; print(json.load(open('config.json'))['offset_seconds'])" 2>/dev/null || echo "30")
              SOURCE="Config"
            else
              OFFSET="30"
              SOURCE="Padrão"
            fi
          fi
          
          # Formatar offset para exibição
          if [ "$OFFSET" -gt 0 ]; then
            OFFSET_STR="+${OFFSET}s"
          else
            OFFSET_STR="${OFFSET}s"
          fi
          
          # Criar mensagem de commit
          COMMIT_MSG="EPG atualizado (${OFFSET_STR}) - $(date -u '+%Y-%m-%d %H:%M UTC') [${SOURCE}]"
          
          echo "commit_message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "offset_used=${OFFSET}" >> $GITHUB_OUTPUT
          echo "offset_display=${OFFSET_STR}" >> $GITHUB_OUTPUT

      - name: 💾 Commit e Push
        run: |
          # Adicionar ficheiros gerados
          git add compilacao.xml compilacao.xml.gz
          
          # Adicionar config.json se foi modificado
          if [ -f "config.json" ]; then
            git add config.json
          fi
          
          # Verificar se há alterações
          if git diff --cached --quiet; then
            echo "📝 Sem alterações nos ficheiros - fonte não foi atualizada"
            exit 0
          fi

          echo "📝 Alterações detetadas - fazendo commit..."
          echo "💬 Mensagem: ${{ steps.commit_info.outputs.commit_message }}"
          
          git commit -m "${{ steps.commit_info.outputs.commit_message }}"
          
          # Push com retry
          max_attempts=3
          for attempt in $(seq 1 $max_attempts); do
            echo "🔄 Push - tentativa $attempt/$max_attempts"
            
            if git push origin main; then
              echo "✅ Push bem-sucedido na tentativa $attempt"
              echo "🎯 Offset aplicado: ${{ steps.commit_info.outputs.offset_display }}"
              break
            else
              echo "⚠️ Push falhou na tentativa $attempt"
              if [ $attempt -lt $max_attempts ]; then
                echo "🔄 Tentando novamente em 10 segundos..."
                sleep 10
                git pull --rebase origin main || git pull --no-edit origin main
              else
                echo "❌ Falha definitiva no push após $max_attempts tentativas"
                exit 1
              fi
            fi
          done

      - name: 📊 Resumo da execução
        if: always()
        run: |
          echo "## 📋 Resumo da Execução EPG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Offset aplicado** | ${{ steps.commit_info.outputs.offset_display }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Data/Hora** | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow ID** | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "compilacao.xml.gz" ]; then
            SIZE=$(ls -lh compilacao.xml.gz | awk '{print $5}')
            echo "| **Ficheiro .gz** | ${SIZE} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "compilacao.xml" ]; then
            SIZE=$(ls -lh compilacao.xml | awk '{print $5}')
            echo "| **Ficheiro .xml** | ${SIZE} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "compilacao.xml.gz" ] && [ -f "compilacao.xml" ]; then
            echo "✅ **Status:** Processamento concluído com sucesso" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Erro no processamento" >> $GITHUB_STEP_SUMMARY
          fi
