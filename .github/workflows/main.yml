name: EPG Processor - Sistema Automatizado

on:
  schedule:
    # Executa a cada 6 horas
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'For√ßar atualiza√ß√£o ignorando cache'
        required: false
        default: 'false'
        type: boolean
      
      debug_mode:
        description: 'Ativar modo debug'
        required: false
        default: 'false'
        type: boolean
      
      custom_offset:
        description: 'Offset personalizado em segundos'
        required: false
        default: '30'
        type: string
  
  push:
    branches: [ main, develop ]
    paths:
      - 'processar.py'
      - 'config.json'
      - 'requirements.txt'
      - '.github/workflows/main.yml'

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: 'v2'

jobs:
  validate-config:
    name: Validar Configura√ß√£o
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
      
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Validar config.json
        id: validate
        run: |
          python -c "
          import json
          import sys
          import os
          
          try:
              with open('config.json', 'r') as f:
                  config = json.load(f)
              
              print('Configura√ß√£o carregada com sucesso')
              print(f'Campos encontrados: {list(config.keys())}')
              
              # Busca source_url em diferentes locais
              source_url = None
              
              # Primeiro, tenta o campo direto
              if 'source_url' in config:
                  source_url = config['source_url']
                  print(f'source_url encontrado diretamente: {source_url}')
              
              # Se n√£o encontrar, tenta dentro de epg_source
              elif 'epg_source' in config and 'source_url' in config['epg_source']:
                  source_url = config['epg_source']['source_url']
                  print(f'source_url encontrado em epg_source: {source_url}')
              
              # Se ainda n√£o encontrar, usa URL padr√£o
              if not source_url:
                  source_url = 'https://epgshare01.online/epgshare01/epg_ripper_PT1.xml.gz'
                  print(f'Usando source_url padr√£o: {source_url}')
                  
                  # Adiciona ao config
                  config['source_url'] = source_url
                  
                  # Salva config atualizado
                  with open('config.json', 'w') as f:
                      json.dump(config, f, indent=2)
                  
                  print('Configura√ß√£o atualizada com source_url padr√£o')
              
              # Valida√ß√£o do offset
              offset = config.get('offset_seconds', 30)
              if not isinstance(offset, int):
                  print(f'Convertendo offset_seconds para int: {offset}')
                  config['offset_seconds'] = int(offset)
                  
                  with open('config.json', 'w') as f:
                      json.dump(config, f, indent=2)
              
              # Valida√ß√£o da URL
              if not source_url.startswith('http'):
                  print(f'URL inv√°lida: {source_url}')
                  sys.exit(1)
              
              # Adiciona app_version se n√£o existir
              if 'app_version' not in config:
                  config['app_version'] = '1.1.0'
                  with open('config.json', 'w') as f:
                      json.dump(config, f, indent=2)
                  print('app_version adicionado')
              
              print('‚úÖ Configura√ß√£o validada com sucesso')
              
              # Define output para pr√≥ximo job
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('valid=true\\n')
              
          except Exception as e:
              print(f'‚ùå Erro na valida√ß√£o: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

  process-epg:
    name: Processar EPG
    runs-on: ubuntu-latest
    needs: validate-config
    if: needs.validate-config.outputs.config-valid == 'true'
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      - name: Cache de depend√™ncias
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-
            
      - name: Cache EPG
        uses: actions/cache@v4
        with:
          path: |
            temp_epg.xml.gz
            temp_epg.xml.gz.cache
          key: epg-cache-${{ env.CACHE_VERSION }}-${{ github.run_number }}
          restore-keys: |
            epg-cache-${{ env.CACHE_VERSION }}-
            epg-cache-
            
      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verificar depend√™ncias
        run: |
          echo "Python: $(python --version)"
          echo "Pip: $(pip --version)"
          echo "Depend√™ncias instaladas:"
          pip list
          
      - name: Verificar arquivos
        run: |
          echo "Arquivos no diret√≥rio:"
          ls -la
          
          echo "Conte√∫do do config.json:"
          cat config.json
          
          echo "Conte√∫do do requirements.txt:"
          cat requirements.txt
          
      - name: Configurar modo debug
        if: ${{ github.event.inputs.debug_mode == 'true' }}
        run: |
          echo "DEBUG_MODE=true" >> $GITHUB_ENV
          echo "üîç Modo debug ativado"
          
      - name: Configurar offset personalizado
        if: ${{ github.event.inputs.custom_offset != '' && github.event.inputs.custom_offset != '30' }}
        run: |
          echo "üîß Configurando offset personalizado: ${{ github.event.inputs.custom_offset }}s"
          
          python -c "
          import json
          
          # Carrega configura√ß√£o atual
          with open('config.json', 'r') as f:
              config = json.load(f)
          
          # Atualiza offset
          config['offset_seconds'] = int('${{ github.event.inputs.custom_offset }}')
          
          # Salva configura√ß√£o
          with open('config.json', 'w') as f:
              json.dump(config, f, indent=2)
          
          print('‚úÖ Offset personalizado configurado')
          "
          
      - name: Limpar cache (se for√ßado)
        if: ${{ github.event.inputs.force_update == 'true' }}
        run: |
          echo "üßπ Limpando cache - for√ßando nova descarga"
          rm -f temp_epg.xml.gz temp_epg.xml.gz.cache
          
      - name: Teste do script
        run: |
          echo "üß™ Testando script..."
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          try:
              # Tenta importar o m√≥dulo
              from processar import EPGProcessor
              print('‚úÖ M√≥dulo processar importado com sucesso')
              
              # Tenta criar inst√¢ncia
              processor = EPGProcessor()
              print('‚úÖ EPGProcessor criado com sucesso')
              
              # Verifica configura√ß√£o
              print(f'üìã Configura√ß√£o carregada: {len(processor.config)} campos')
              
          except Exception as e:
              print(f'‚ùå Erro no teste: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
          
      - name: Processar EPG
        id: process
        run: |
          echo "üöÄ Iniciando processamento EPG..."
          
          # Configura timeout e executa
          timeout 1800 python processar.py 2>&1 | tee process.log || {
            echo "‚ùå Processamento falhou ou excedeu timeout"
            echo "üìã √öltimas 20 linhas do log:"
            tail -20 process.log
            exit 1
          }
          
          # Verifica se o arquivo foi criado
          if [ -f "epg_timeshift.xml" ] || [ -f "epg_timeshift.xml.gz" ]; then
            echo "‚úÖ EPG processado com sucesso"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Falha: arquivo de sa√≠da n√£o encontrado"
            echo "üìÅ Arquivos no diret√≥rio:"
            ls -la
            exit 1
          fi
          
      - name: Gerar estat√≠sticas
        if: steps.process.outputs.success == 'true'
        run: |
          echo "üìä Gerando estat√≠sticas..."
          
          # Tenta gerar estat√≠sticas
          python processar.py --stats > stats.json 2>&1 || {
            echo "‚ö†Ô∏è Erro ao gerar estat√≠sticas detalhadas"
            echo '{"error": "N√£o foi poss√≠vel gerar estat√≠sticas"}' > stats.json
          }
          
          # Exibe estat√≠sticas
          echo "=== ESTAT√çSTICAS DO PROCESSAMENTO ==="
          cat stats.json
          
          # Verifica tamanho do arquivo
          if [ -f "epg_timeshift.xml.gz" ]; then
            FILE_SIZE=$(stat -c%s epg_timeshift.xml.gz)
            echo "üì¶ Tamanho do arquivo comprimido: $FILE_SIZE bytes"
            echo "OUTPUT_FILE=epg_timeshift.xml.gz" >> $GITHUB_ENV
          elif [ -f "epg_timeshift.xml" ]; then
            FILE_SIZE=$(stat -c%s epg_timeshift.xml)
            echo "üìÑ Tamanho do arquivo XML: $FILE_SIZE bytes"
            echo "OUTPUT_FILE=epg_timeshift.xml" >> $GITHUB_ENV
          fi
          
      - name: Validar arquivo de sa√≠da
        if: steps.process.outputs.success == 'true'
        run: |
          echo "üîç Validando arquivo de sa√≠da..."
          
          if [ -f "epg_timeshift.xml.gz" ]; then
            echo "üì¶ Validando arquivo comprimido..."
            gunzip -t epg_timeshift.xml.gz && echo "‚úÖ Arquivo GZ v√°lido"
          elif [ -f "epg_timeshift.xml" ]; then
            echo "üìÑ Validando arquivo XML..."
            python -c "
            from lxml import etree
            try:
                tree = etree.parse('epg_timeshift.xml')
                root = tree.getroot()
                channels = len(root.findall('channel'))
                programmes = len(root.findall('programme'))
                print(f'‚úÖ XML v√°lido: {channels} canais, {programmes} programas')
            except Exception as e:
                print(f'‚ùå Erro na valida√ß√£o: {e}')
                exit(1)
            "
          else
            echo "‚ùå Arquivo de sa√≠da n√£o encontrado"
            exit 1
          fi
          
      - name: Upload dos artefatos
        if: steps.process.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: epg-processed-${{ github.run_number }}
          path: |
            ${{ env.OUTPUT_FILE }}
            stats.json
            epg_processor.log
            process.log
            config.json
          retention-days: 30
          
      - name: Criar release
        if: steps.process.outputs.success == 'true' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "epg-${{ github.run_number }}"
          name: "EPG Timeshift - ${{ github.run_number }}"
          body: |
            ## üì∫ EPG Processado Automaticamente
            
            **üïê Data:** ${{ github.event.head_commit.timestamp }}
            **üîó Commit:** ${{ github.sha }}
            **üë§ Executado por:** ${{ github.actor }}
            
            ### üìä Estat√≠sticas
            ```json
            ${{ steps.process.outputs.stats }}
            ```
            
            ### üìÅ Arquivos inclu√≠dos
            - `${{ env.OUTPUT_FILE }}` - EPG com timeshift aplicado
            - `stats.json` - Estat√≠sticas do processamento
            - `epg_processor.log` - Log detalhado do processamento
            - `process.log` - Log da execu√ß√£o
            
            ### ‚öôÔ∏è Configura√ß√£o utilizada
            - **Offset:** ${{ github.event.inputs.custom_offset || '30' }}s
            - **Cache:** ${{ github.event.inputs.force_update == 'true' && 'Desabilitado' || 'Habilitado' }}
            - **Debug:** ${{ github.event.inputs.debug_mode == 'true' && 'Ativado' || 'Desativado' }}
            
          files: |
            ${{ env.OUTPUT_FILE }}
            stats.json
            epg_processor.log
            process.log
          draft: false
          prerelease: false
          
      - name: Atualizar configura√ß√£o
        if: steps.process.outputs.success == 'true' && github.ref == 'refs/heads/main'
        run: |
          echo "üîÑ Atualizando timestamp da configura√ß√£o..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Atualizar timestamp no config.json
          python -c "
          import json
          from datetime import datetime
          
          with open('config.json', 'r') as f:
              config = json.load(f)
          
          config['last_update'] = datetime.now().isoformat()
          
          with open('config.json', 'w') as f:
              json.dump(config, f, indent=2)
          
          print('‚úÖ Timestamp atualizado')
          "
          
          # Commit apenas se houver mudan√ßas
          git add config.json
          git diff --staged --quiet || {
            git commit -m "ü§ñ Atualiza√ß√£o autom√°tica EPG - $(date)"
            git push
            echo "‚úÖ Configura√ß√£o commitada"
          }
          
      - name: Log final
        if: always()
        run: |
          echo "üìã RESUMO DA EXECU√á√ÉO"
          echo "Status: ${{ job.status }}"
          echo "Sucesso no processamento: ${{ steps.process.outputs.success }}"
          
          if [ -f "epg_processor.log" ]; then
            echo "üìÑ √öltimas linhas do log:"
            tail -10 epg_processor.log
          fi

  cleanup:
    name: Limpeza
    runs-on: ubuntu-latest
    needs: [validate-config, process-epg]
    if: always()
    
    steps:
      - name: Limpar artefatos antigos
        uses: geekyeggo/delete-artifact@v5
        with:
          name: epg-processed-*
          useGlob: true
          failOnError: false
          
      - name: Status final
        run: |
          echo "üèÅ Workflow conclu√≠do"
          echo "Valida√ß√£o: ${{ needs.validate-config.result }}"
          echo "Processamento: ${{ needs.process-epg.result }}"
