# .github/workflows/main.yml
name: Processar EPG Di√°rio

on:
  schedule:
    - cron: '0 4 * * *'  # 04:00 UTC = 05:00 Portugal
  workflow_dispatch:

jobs:
  process-epg:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Processar EPG
        run: |
          echo "üöÄ Iniciando processamento EPG..."
          python processar.py
          echo "‚úÖ Processamento conclu√≠do"

      - name: Verificar ficheiros gerados
        run: |
          if [ ! -f "compilacao.xml.gz" ]; then
            echo "‚ùå Erro: compilacao.xml.gz n√£o foi criado"
            exit 1
          fi
          
          echo "üìä Informa√ß√µes do ficheiro gerado:"
          ls -lh compilacao.xml.gz
          echo "‚úÖ Ficheiro compilacao.xml.gz criado com sucesso"

      - name: Commit e Push (apenas se houver mudan√ßas)
        run: |
          git config --local user.name 'github-actions[bot]'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'

          # Adicionar o ficheiro final
          git add compilacao.xml.gz
          
          # Verificar se realmente h√° altera√ß√µes no conte√∫do
          if git diff --cached --quiet; then
            echo "üìù Sem altera√ß√µes no ficheiro EPG - fonte n√£o foi atualizada"
            exit 0
          fi

          echo "üìù Altera√ß√µes detetadas - a fazer commit..."
          git commit -m "EPG atualizado - $(date '+%Y-%m-%d %H:%M UTC')"
          
          # Push com retry em caso de falha
          for attempt in {1..3}; do
            if git push; then
              echo "‚úÖ Push bem-sucedido na tentativa $attempt"
              break
            else
              echo "‚ö†Ô∏è Push falhou na tentativa $attempt"
              if [ $attempt -lt 3 ]; then
                echo "üîÑ A tentar novamente em 10 segundos..."
                sleep 10
                git pull --rebase origin main
              else
                echo "‚ùå Falha definitiva no push ap√≥s 3 tentativas"
                exit 1
              fi
            fi
          done

---

# .github/workflows/Limpeza.yml - REMOVIDO
# Este workflow n√£o √© necess√°rio e causa conflitos.
# A limpeza deve ser feita ANTES da compila√ß√£o, n√£o DEPOIS.
