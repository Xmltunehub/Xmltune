# .github/workflows/main.yml
name: EPG Update Workflow

on:
  workflow_dispatch:
    inputs:
      offset_seconds:
        description: 'Offset em segundos (+/-)'
        required: false
        default: '0'
        type: string
      update_default:
        description: 'Atualizar configuraÃ§Ã£o padrÃ£o'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 */4 * * *'  # A cada 4 horas

jobs:
  update-epg:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do repositÃ³rio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch completo do histÃ³rico
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âš™ï¸ Configurar Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "github-actions[bot]"
        git config --local pull.rebase false  # Usar merge em vez de rebase
    
    - name: ðŸ”„ Sincronizar com remote (com retry)
      run: |
        echo "ðŸ”„ A sincronizar com o repositÃ³rio remoto..."
        
        # FunÃ§Ã£o de retry
        retry_pull() {
          local max_attempts=5
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ”„ Tentativa $attempt de $max_attempts..."
            
            # Stash qualquer mudanÃ§a local
            git stash push -m "Auto-stash before pull" || true
            
            # Pull das mudanÃ§as remotas
            if git pull origin main --no-edit; then
              echo "âœ… Pull realizado com sucesso!"
              
              # Restaurar stash se existir
              if git stash list | grep -q "Auto-stash before pull"; then
                git stash pop || echo "âš ï¸ Aviso: NÃ£o foi possÃ­vel restaurar stash"
              fi
              
              return 0
            else
              echo "âš ï¸ Pull falhou na tentativa $attempt"
              sleep $((attempt * 5))  # Esperar mais tempo a cada tentativa
              attempt=$((attempt + 1))
            fi
          done
          
          echo "âŒ Falha ao sincronizar apÃ³s $max_attempts tentativas"
          return 1
        }
        
        retry_pull
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: ðŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        # Adicionar as tuas dependÃªncias aqui
        # pip install -r requirements.txt
    
    - name: ðŸŽ¯ Processar EPG
      run: |
        echo "ðŸŽ¯ A processar EPG com offset: ${{ github.event.inputs.offset_seconds || '0' }}s"
        
        # O teu script de processamento aqui
        # python process_epg.py --offset=${{ github.event.inputs.offset_seconds || '0' }}
        
        # Para demonstraÃ§Ã£o, criar um ficheiro de teste
        echo "EPG processado em $(date) com offset ${{ github.event.inputs.offset_seconds || '0' }}s" > epg_update.log
    
    - name: ðŸ’¾ Commit e Push (com proteÃ§Ã£o contra conflitos)
      run: |
        echo "ðŸ’¾ A verificar alteraÃ§Ãµes..."
        
        # Verificar se hÃ¡ alteraÃ§Ãµes
        if git diff --quiet && git diff --staged --quiet; then
          echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o detetada - a saltar commit"
          exit 0
        fi
        
        echo "ðŸ“ AlteraÃ§Ãµes detetadas - a preparar commit..."
        
        # FunÃ§Ã£o para commit com retry
        safe_commit_push() {
          local max_attempts=3
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ“ Tentativa de commit e push $attempt de $max_attempts..."
            
            # Sincronizar novamente antes do commit
            git stash push -m "Pre-commit stash" || true
            
            if git pull origin main --no-edit; then
              # Restaurar stash
              if git stash list | grep -q "Pre-commit stash"; then
                if ! git stash pop; then
                  echo "âš ï¸ Conflito no stash - a resolver automaticamente"
                  git reset --hard HEAD
                  git stash drop || true
                fi
              fi
              
              # Adicionar alteraÃ§Ãµes
              git add .
              
              # Commit se hÃ¡ alteraÃ§Ãµes
              if ! git diff --staged --quiet; then
                git commit -m "EPG atualizado - $(date -u '+%Y-%m-%d %H:%M') UTC
                
                Offset aplicado: ${{ github.event.inputs.offset_seconds || '0' }}s
                Workflow: ${{ github.run_id }}
                Triggered by: ${{ github.event_name }}"
                
                # Push com retry
                if git push origin main; then
                  echo "âœ… Push realizado com sucesso!"
                  return 0
                else
                  echo "âš ï¸ Push falhou na tentativa $attempt"
                fi
              else
                echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o para commit apÃ³s merge"
                return 0
              fi
            else
              echo "âš ï¸ Pull falhou na tentativa $attempt"
            fi
            
            attempt=$((attempt + 1))
            sleep $((attempt * 3))
          done
          
          echo "âŒ Falha no commit/push apÃ³s $max_attempts tentativas"
          return 1
        }
        
        safe_commit_push
    
    - name: ðŸ“Š Atualizar configuraÃ§Ã£o padrÃ£o
      if: ${{ github.event.inputs.update_default == 'true' }}
      run: |
        echo "ðŸ“Š A atualizar configuraÃ§Ã£o padrÃ£o..."
        
        # Criar/atualizar config.json
        cat > config.json << EOF
        {
          "default_offset": ${{ github.event.inputs.offset_seconds || '0' }},
          "last_updated": "$(date -u -Iseconds)",
          "updated_by": "github-actions[bot]",
          "workflow_run": "${{ github.run_id }}"
        }
        EOF
        
        # Commit da configuraÃ§Ã£o
        git add config.json
        if ! git diff --staged --quiet; then
          git commit -m "ConfiguraÃ§Ã£o padrÃ£o atualizada - offset: ${{ github.event.inputs.offset_seconds || '0' }}s"
          git push origin main || echo "âš ï¸ Aviso: Push da configuraÃ§Ã£o falhou"
        fi
    
    - name: ðŸ“¢ NotificaÃ§Ã£o de sucesso
      if: success()
      run: |
        echo "ðŸŽ‰ Workflow concluÃ­do com sucesso!"
        echo "â° Offset aplicado: ${{ github.event.inputs.offset_seconds || '0' }}s"
        echo "ðŸ• Timestamp: $(date -u)"
        echo "ðŸ”— Run ID: ${{ github.run_id }}"
    
    - name: ðŸ“¢ NotificaÃ§Ã£o de erro
      if: failure()
      run: |
        echo "âŒ Workflow falhou!"
        echo "ðŸ” Verificar logs para mais detalhes"
        echo "ðŸ”— Run ID: ${{ github.run_id }}"
